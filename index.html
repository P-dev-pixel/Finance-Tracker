<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="nav">
      <a href="addUser.html">AddUser</a><a href="#about">About</a>
    </div>
    <div id="container">
      <div id="inpField">
        <input type="text" placeholder="Enter the Product Name" />
        <input type="number" min="1" placeholder="Enter the Price" />
      </div>
      <select name="" id="category">
        <option value="" disabled selected>Choose Type</option>
        <option value="Gi">General Items</option>
        <option value="RE">Room Expendure</option>
      </select>
      <select name="" id="name">
        <option value="" disabled selected>Choose The Name</option>
      </select>

      <button>Add</button>

      <a href="room.html">Show The Romm Expendure</a>
      <a href="grocery.html">Show The Grocery Expendure</a>
    
    </div>

    <div id="listCon">
      <table id="room">
        <tr>
          <th>S.No</th>
          <th>Date</th>
          <th>Product Name</th>
          <th>Price</th>
        </tr>
      </table>
      <h1></h1>
      <div id="roomControls">
        <button id="totalRoom">Total</button>
        <button id="deleteRoom">Delete</button>
        <button id="clearRoom">Clear All</button>
        <button id="downloadRoom">Download PDF</button>
        <input type="number" id="splitRoom" placeholder="enther the count" />
      </div>

      <table id="grocery">
        <tr>
          <th>S.No</th>
          <th>Name</th>
          <th>Product Name</th>
          <th>Price</th>
        </tr>
      </table>
      <h1></h1>
      <div id="groceryControls">
        <button id="totalGrocery">Total</button>
        <button id="deleteGrocery">Delete</button>
        <button id="clearGrocery">Clear All</button>
        <button id="downloadGrocery">Download PDF</button>
        <input type="number" id="splitGrocery" placeholder="enther the count" />
      </div>
    </div>
 
    <h1 id="result"></h1>
    <h1 id="sAmt"></h1>

    <script>
      const dis = document.getElementById("listCon");
      // dis.style.display = "none";
      const addList = document.querySelectorAll("button")[0];

      const deletRoom = document.getElementById("deleteRoom");
      const deleteGrocery = document.getElementById("deleteGrocery");
      const clearRoom = document.getElementById("clearRoom");
      const clearGrocery = document.getElementById("clearGrocery");

      const totalGrocery = document.getElementById("totalGrocery");
      const totalRoom = document.getElementById("totalRoom");
      const ce = document.createElement("h1");

      const room = document.getElementById("room");
      const grocery = document.getElementById("grocery");

      const roomRows = room.getElementsByTagName("tr");
      const groceryRows = grocery.getElementsByTagName("tr");

      const select = document.getElementsByTagName("select")[0];
      const name = document.getElementById("name");

      addList.style.display = "none";

  window.addEventListener('DOMContentLoaded', () => {
    // get existing users from localStorage
    let users = JSON.parse(localStorage.getItem('users')) || [];
    let select = document.getElementById('name');

    users.forEach(user => {
      // check if user already exists in dropdown (to avoid duplicate)
      let alreadyExists = Array.from(select.options).some(opt => opt.value === user);
      if (!alreadyExists) {
        let option = document.createElement('option');
        option.value = user;
        option.textContent = user;
        select.appendChild(option);
      }
    });
  });
      // Selector control
      select.addEventListener("click", () => {
        document
          .querySelectorAll("input")
          .forEach((input) => (input.value = ""));
        if (select.value === "RE") {
          addList.style.display = "block";
          name.style.display = "none";
        } else if (select.value === "Gi") {
          name.style.display = "block";
          addList.style.display = "block";
        } else addList.style.display = "none";
      });

      let roomCount = 1;
      let groceryCount = 1;

      // Add Row (Room / Grocery)
      addList.addEventListener("click", () => {
        const currentTable = select.value; // always read fresh
        const Product = document.querySelectorAll("input")[0].value.trim();
        const price = parseFloat(document.querySelectorAll("input")[1].value);
        const date = new Date();

        // Grocery table
        if (currentTable === "Gi") {
          let nameVal = name.value.trim();
          if (!nameVal) {
            name.style.border = "2px solid red";
            return;
          }
          name.style.border = "none";

          if (Product === "" || price <= 0 || isNaN(price)) {
            document.querySelectorAll("input")[0].style.border =
              "2px solid red";
            document.querySelectorAll("input")[1].style.border =
              "2px solid red";
            return;
          }

          document.querySelectorAll("input")[0].style.border = "none";
          document.querySelectorAll("input")[1].style.border = "none";

          const newRow = document.createElement("tr");
          newRow.innerHTML = `
          <td>${groceryCount++}</td>
          <td>${nameVal}</td>
          <td>${Product}</td>
          <td>${price}</td>`;
          grocery.appendChild(newRow);
        }

        // Room table
        else if (currentTable === "RE") {
          if (Product === "" || price <= 0 || isNaN(price)) {
            document.querySelectorAll("input")[0].style.border =
              "2px solid red";
            document.querySelectorAll("input")[1].style.border =
              "2px solid red";
            return;
          }

          document.querySelectorAll("input")[0].style.border = "none";
          document.querySelectorAll("input")[1].style.border = "none";

          const newRow = document.createElement("tr");
          newRow.innerHTML = `
          <td>${roomCount++}</td>
          <td>  ${date.getDate()}/${date.getMonth()}/ 2025</td>
          <td>${Product}</td>
          <td>${price}</td>`;
          room.appendChild(newRow);
        }

        document.querySelectorAll("input")[0].value = "";
        document.querySelectorAll("input")[1].value = "";
        saveData();
      });

      // Total calculation
      totalGrocery.addEventListener("click", () => {
        const split = document.getElementById("splitGrocery");
        calTotal(grocery, groceryRows, split);
      });
      totalRoom.addEventListener("click", () => {
        const split = document.getElementById("splitRoom");
        calTotal(room, roomRows, split);
      });

      function calTotal(totalVal, rows, split) {
        let sum = 0;
        let splitCount = 1;
        const totals = {};
        for (let i = 0; i < rows.length; i++) {
          const tds = rows[i].querySelectorAll("td");
          if (tds.length >= 4) sum += parseFloat(tds[3].textContent);
        }

        if (split.value) {
          const h1 = document.getElementById("listCon");
          splitCount = parseInt(split.value);
          ce.innerHTML = `Split Amount for ${splitCount} person is: ${(
            sum / splitCount
          ).toFixed(2)}`;
          h1.appendChild(ce);

          const grRow = grocery.querySelectorAll("tr:not(:first-child)");
          const sample = Array.from(grRow).map((row) => {
            const tds = row.querySelectorAll("td");
            return Array.from(tds).map((td) => td.textContent.trim());
          });
          
          for (let i = 0; i < sample.length; i++) {
            const [id, name, item, amount] = sample[i];
            const value = Number(amount) || 0;
            if (!totals[name]) {
              totals[name] = 0;
            }
            totals[name] += value;
          }

          console.log(totals);
        }
        document.getElementById(
          "result"
        ).innerHTML = `Total: <span>${sum}</span>`;
      }
      // Delete last row
      deletRoom.addEventListener("click", () => deleteRow(roomRows, "room"));
      deleteGrocery.addEventListener("click", () =>
        deleteRow(groceryRows, "grocery")
      );
      function deleteRow(rows, type) {
        if (rows.length > 1) {
          rows[rows.length - 1].remove();
          if (type === "room") roomCount--;
          else if (type === "grocery") groceryCount--;
        }
      }
      // Clear all
      clearGrocery.addEventListener("click", () =>
        clearAll(grocery, "grocery")
      );
      clearRoom.addEventListener("click", () => clearAll(room, "room"));

      function clearAll(table, type) {
        let rows = table.querySelectorAll("tr:not(:first-child)");
        while (rows.length > 0) {
          rows[rows.length - 1].remove();
          rows = table.querySelectorAll("tr:not(:first-child)");
        }
        if (type === "room") roomCount = 1;
        else if (type === "grocery") groceryCount = 1;
        document.getElementById("result").innerHTML = "";
      }

      // Save & Restore
      function saveData() {
        const rows = room.querySelectorAll("tr:not(:first-child)");
        const grRow = grocery.querySelectorAll("tr:not(:first-child)");
        const rowsHTML = Array.from(rows)
          .map((row) => row.outerHTML)
          .join("");
        const grHtml = Array.from(grRow)
          .map((row) => row.outerHTML)
          .join("");
        sessionStorage.setItem("GrRow", grHtml);
        sessionStorage.setItem("List", rowsHTML);
      }

      function showTask() {
        const savedData = sessionStorage.getItem("List");
        const grData = sessionStorage.getItem("GrRow");
        if (savedData || grData) {
          room.innerHTML =
            `<tr>
          <th>S.No</th>
          <th>Date(DD/MM/YYYY)</th>
          <th>Type</th>
          <th>Amount</th>
        </tr>` + (savedData || "");
          grocery.innerHTML =
            `<tr>
          <th>S.No</th>
          <th>Name</th>
          <th>Product Name</th>
          <th>Price</th>
        </tr>` + (grData || "");
          roomCount = room.rows.length;
          groceryCount = grocery.rows.length;
        }
      }

  
      showTask();
    </script>
    <!-- <script src="main.js"></script> -->
  </body>
</html>
